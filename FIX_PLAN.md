# План исправлений и подготовки к тестированию (Backend + Bot + DB)

## Цели
- Устранить расхождения между БД, Backend и Bot.
- Стабилизировать критические потоки: регистрация продавца, создание магазина, добавление товара, подписки, заказы, оплаты.
- Подготовить окружение и тестовые сценарии для гладкого ручного тестирования.

## Сводка текущего состояния
- БД приведена к актуальной схеме; денежные поля расширены до DECIMAL(18,8).
- Backend и Bot запущены; интеграция базовых флоу работает, но остались шероховатости.
- Подробный аудит: `PROJECT_AUDIT.md`.

---

## Блок 1. База данных

Проблемы и решения:
1) Неверная точность денежных полей (создание товара падало) — ИСПРАВЛЕНО
- Файлы: `backend/database/schema.sql`
- Что сделано: увеличены поля `products.price`, `orders.total_price`, `order_items.price`, `shop_payments.amount` до `DECIMAL(18,8)`; применены ALTER к живой БД.
- Действия для тестов: проверить создание товара с ценой > 100; оформить заказ; проверить запись платежа.

2) Индексы и производительность — НУЖНО СДЕЛАТЬ
- Проблема: нет явных индексов на FK и фильтруемые поля.
- Решение:
  - Добавить индексы: `shops(owner_id)`, `products(shop_id, is_active)`, `subscriptions(shop_id)`, `subscriptions(user_id)`, `orders(buyer_id)`, `orders(product_id)`, `payments(order_id, status)`.
  - SQL (пример):
    - `CREATE INDEX IF NOT EXISTS idx_shops_owner ON shops(owner_id);`
    - `CREATE INDEX IF NOT EXISTS idx_products_shop ON products(shop_id);`
    - `CREATE INDEX IF NOT EXISTS idx_products_active ON products(is_active);`
    - `CREATE INDEX IF NOT EXISTS idx_subscriptions_user ON subscriptions(user_id);`
    - `CREATE INDEX IF NOT EXISTS idx_subscriptions_shop ON subscriptions(shop_id);`
    - `CREATE INDEX IF NOT EXISTS idx_orders_buyer ON orders(buyer_id);`
    - `CREATE INDEX IF NOT EXISTS idx_orders_product ON orders(product_id);`

3) Обработка уникальности имени магазина — НУЖНО СДЕЛАТЬ
- Проблема: `shops.name` уникален, но контроллер не отлавливает 23505 → 500.
- Решение: ловить PG ошибки (23505) через `dbErrorHandler` и отдавать 409 с понятным сообщением.
- Файл: `backend/src/controllers/shopController.js` (create)

4) Неиспользуемые сущности — ПРОВЕРИТЬ
- Таблица `shop_payments` для $25 регистрации не используется в текущем флоу.
- Решение: либо интегрировать в флоу регистрации продавца, либо убрать из публичных сценариев и документации.

5) Согласованность статусов — НУЖНО СДЕЛАТЬ
- Проблема: статусы в `constants.js` и в БД/контроллерах расходятся.
  - БД/контроллеры заказов: `pending, confirmed, shipped, delivered, cancelled`.
  - constants: есть `PAID, PROCESSING, COMPLETED, REFUNDED, AWAITING_PAYMENT`.
- Решение: привести к одному словарю и обновить валидации/документацию.

---

## Блок 2. Backend

Проблемы и решения:
1) Проверка владения магазином — ИСПРАВЛЕНО
- Файл: `backend/src/middleware/auth.js`
- Что сделано: заменён вызов на `shopQueries.findByOwnerId`.

2) Валидация товаров — ИСПРАВЛЕНО
- Файлы: `backend/src/middleware/validation.js`, `backend/src/controllers/productController.js`
- Что сделано: `description`, `stockQuantity/stock` — опциональны; нормализация `stockQuantity` в контроллере.

3) Поиск магазинов — ИСПРАВЛЕНО
- Файлы: `backend/src/routes/shops.js`, `backend/src/controllers/shopController.js`, `backend/src/models/db.js`
- Что сделано: эндпоинт `/api/shops/search` + запрос `searchByName`, опциональная аутентификация (флаг подписки).

4) Листинг заказов — ИСПРАВЛЕНО
- Файл: `backend/src/routes/orders.js`
- Что сделано: добавлены маршруты `/api/orders` (покупатель) и `/api/orders/sales` (продавец).

5) Обработка ошибок БД — НУЖНО СДЕЛАТЬ
- Проблема: контроллеры местами возвращают 500 на ожидаемые ошибки (конфликт, FK и т.д.).
- Решение: использовать `dbErrorHandler` в `catch` и маппить PG-коды на 4xx.

6) Crypto/Payments — ПРОВЕРИТЬ
- Несоответствие `payments` статусов и `PAYMENT_STATUS` в `constants.js` (confirmed vs completed и т.п.).
- Метод `paymentApi.generateAddress` в боте — нет соответствующего эндпоинта. Решение: реализовать или удалить из бота.

7) Health/Ready — УЛУЧШИТЬ
- `/health` сейчас без проверки БД. Решение: добавить лёгкую проверку соединения/latency БД, версию БД.

---

## Блок 3. Bot

Проблемы и решения:
1) Сессии — УЛУЧШИТЬ
- Сейчас in-memory `telegraf/session` теряется при рестарте.
- Решение: подключить Redis-хранилище или file-based store (например, `telegraf-session-redis`). Хранить `token`, `shopId`, `shopName`.

2) Дублирование API-клиентов — УБРАТЬ ЛИШНЕЕ
- Папка `bot/api/*` (client.js и модули) не используется; рабочий клиент — `bot/src/utils/api.js`.
- Решение: удалить/архивировать `bot/api/*` или унифицировать, чтобы не путать разработчиков.

3) Ввод валюты при добавлении товара — ОПТИМИЗИРОВАТЬ UX
- Сейчас требуется явный выбор валюты.
- Решение: 
  - Если в конфиге включена 1 валюта — пропускать шаг и подставлять по умолчанию.
  - Если несколько — оставлять выбор. 
- Файлы: `bot/src/config/index.js`, `bot/src/scenes/addProduct.js` (условно пропускать шаг при `config.currencies.length === 1`).

4) Обработка ошибок API — УЛУЧШИТЬ UX
- При сетевых/401/403 выводить дружелюбные сообщения и предлагать вернуться в меню.
- Файл: `bot/src/middleware/error.js` (уже есть), дополнить кейсами.

5) Подписки/Поиск — ПРОВЕРИТЬ
- После изменений эндпоинтов проверять корректный рендер имени магазина (`shop_name` vs `shopName`), флаг `is_subscribed`.
- Файлы: `bot/src/handlers/buyer/index.js`, `bot/src/scenes/searchShop.js` — уже учтено, но нужна прогонка тестов.

6) Платежи — ПРОВЕРИТЬ/СИНХРОНИЗИРОВАТЬ
- Если платежный флоу не используется — скрыть пункты меню/кнопки, чтобы не вводить в заблуждение.

---

## Блок 4. Интеграция и консистентность

Проблемы и решения:
1) Константы статусов — СИНХРОНИЗАЦИЯ
- Привести `backend/src/utils/constants.js` к реальным статусам БД. Обновить валидации и хелперы.

2) Сообщения/локализация — УНИФИКАЦИЯ
- Пройтись по текстам в боте: единый стиль, одинаковая терминология, подсказки при ошибках.

3) Логи — ДОБАВИТЬ МЕТКИ КОРРЕЛЯЦИИ
- Включить `requestId`/`userId` в бэкенде и боте для сквозной трассировки. Прокидывать `X-Request-ID`.

4) Документация — АКТУАЛИЗАЦИЯ
- Обновить README и QUICKSTART (порты, .env примеры, валюты, новые роуты).

---

## Чек-лист тестирования (ручной прогон)

1) Продавец
- /start → «Продавец» → «Создать магазин» → ввести уникальное имя → магазин создан, `shopId` в сессии.
- «Добавить товар» → ввести название → цену (например 123.45678901) → выбрать/пропустить валюту → товар создан.
- "+" повторный товар → проверка листинга товаров в webapp.

2) Покупатель
- /start → «Покупатель» → «Найти магазин» → ввести название → карточка магазина → «Подписаться».
- Проверить «Подписки» — список содержит магазин.

3) Заказы
- Создать тестовый товар, сделать заказ (если UI доступен) → проверить записи `orders`, `order_items` (если используются), `payments` (опционально).

4) Ошибки/края
- Попытка создать магазин с существующим именем → 409 и понятное сообщение.
- Создать товар без описания/stock → успешно (описание опционально, stock по умолчанию 0).
- Отключить backend и попробовать действия в боте → дружелюбные сообщения об ошибке.

---

## Порядок работ (Sprint-план)

P1 (Критично):
- [x] Синхронизировать статусы заказов/платежей в `constants.js` и валидациях.
- [x] Обработать PG-ошибки (23505, 23503, 23502) в контроллерах (shops/products/orders) через `dbErrorHandler`.
- [x] Добавить индексы для FK/фильтров.

P2 (Высокий приоритет):
- [ ] Добавить DB-check к `/health`.
- [ ] Оптимизировать шаг выбора валюты в боте (auto/default).
- [ ] Удалить/законсервировать `bot/api/*` чтобы избежать путаницы.

P3 (Средний):
- [ ] Перевести сессии бота на Redis-хранилище.
- [ ] Включить `X-Request-ID` корреляцию логов.
- [ ] Обновить документацию.

P4 (Низкий):
- [ ] Скрыть/реализовать платежный флоу (generateAddress) — определиться.

---

## Замечания по окружению
- Бэкенд .env: проверь `DATABASE_URL`, `JWT_SECRET`, `TELEGRAM_BOT_TOKEN`, `FRONTEND_URL`.
- Бот .env: проверь `BOT_TOKEN`, `BACKEND_URL`, `WEBAPP_URL`.
- Версии Node: не ниже 18 для обоих пакетов.

---

## Роллбэк
- Имеется `schema.sql`; критичные миграции выполнять через ALTER/backup. Хранить дамп перед изменениями.

---

## Критерии готовности к демо
- Все P1 задачи закрыты.
- Чек-лист ручного тестирования проходит без ошибок.
- Логов уровня error/fatal на старте и при базовых сценариях нет.
