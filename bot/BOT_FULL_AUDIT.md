# –ü–æ–ª–Ω—ã–π –∞—É–¥–∏—Ç Telegram –±–æ—Ç–∞ Status Stock

**–î–∞—Ç–∞:** 2025-10-22
**–°—Ç–∞—Ç—É—Å —Ç–µ—Å—Ç–æ–≤:** 118/119 passed (99.2% success rate)
**–§—Ä–µ–π–º–≤–æ—Ä–∫:** Telegraf.js
**–ê—É–¥–∏—Ç–æ—Ä:** Claude Code (via MCP filesystem)

---

## Executive Summary

### –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞: 85/100

**–°–∏–ª—å–Ω—ã–µ —Å—Ç–æ—Ä–æ–Ω—ã:**
- ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (scenes + handlers + keyboards)
- ‚úÖ –û—Ç–ª–∏—á–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ (try-catch everywhere)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö —Å–æ–±—ã—Ç–∏–π
- ‚úÖ –ö—Ä–∏–ø—Ç–æ-–≤–∞–ª–∏–¥–∞—Ü–∏—è (BTC/ETH/USDT/TON)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π UX —Å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–º–∏ —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
- ‚úÖ Session management –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω

**–ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (P0):** 0
**–í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (P1):** 3
**Nice to Have (P2):** 8

---

## 1. –°—Ü–µ–Ω—ã (Scenes)

### 1.1 createShop.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –∏–º–µ–Ω–∏ –º–∞–≥–∞–∑–∏–Ω–∞ (3-100 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ Token presence check (—Å—Ç—Ä–æ–∫–∞ 58)
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ API (try-catch)
- ‚úÖ Session update —Å –≤–∞–ª–∏–¥–∞—Ü–∏–µ–π (—Å—Ç—Ä–æ–∫–∞ 87-90)
- ‚úÖ answerCbQuery() –≤ cancel_scene handler
- ‚úÖ Wizard state cleanup –≤ leave handler

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–∂–¥–æ–≥–æ —à–∞–≥–∞ wizard
- –ü—Ä–æ–≤–µ—Ä–∫–∞ `shop.id` –ø–µ—Ä–µ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –≤ session
- Graceful error handling —Å fallback –Ω–∞ successButtons

**Edge cases —É—á—Ç–µ–Ω—ã:**
- ‚úÖ –ü—É—Å—Ç–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å—Ç—Ä–æ–∫–∞ 34)
- ‚úÖ –°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–æ–µ/–¥–ª–∏–Ω–Ω–æ–µ –∏–º—è
- ‚úÖ API –æ—à–∏–±–∫–∞ ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –ø–æ–Ω—è—Ç–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
- ‚úÖ Invalid shop object –æ—Ç API (—Å—Ç—Ä–æ–∫–∞ 77-79)

---

### 1.2 addProduct.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ 3-step wizard –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (name ‚Üí price ‚Üí save)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è —Ü–µ–Ω—ã (> 0, parseFloat —Å –∑–∞–ø—è—Ç–æ–π/—Ç–æ—á–∫–æ–π)
- ‚úÖ shopId presence check –ü–ï–†–ï–î API call (—Å—Ç—Ä–æ–∫–∞ 91-100)
- ‚úÖ Token presence check (—Å—Ç—Ä–æ–∫–∞ 103)
- ‚úÖ Wizard state –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è product object –ø–æ—Å–ª–µ API (—Å—Ç—Ä–æ–∫–∞ 127-130)

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- –ó–∞–º–µ–Ω–∞ –∑–∞–ø—è—Ç–æ–π –Ω–∞ —Ç–æ—á–∫—É –≤ —Ü–µ–Ω–µ (—Å—Ç—Ä–æ–∫–∞ 73)
- –Ø–≤–Ω–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è isNaN(price) && price <= 0
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± –æ—à–∏–±–∫–∞—Ö (—Å—Ç—Ä–æ–∫–∞ 77)

**Edge cases —É—á—Ç–µ–Ω—ã:**
- ‚úÖ –¢–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ —á–∏—Å–ª–∞ –≤ —Ü–µ–Ω–µ ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –ø—Ä–∏–º–µ—Ä
- ‚úÖ –û—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω–∞—è —Ü–µ–Ω–∞
- ‚úÖ –ù–µ—Ç shopId –≤ session ‚Üí –≤—ã—Ö–æ–¥ –∏–∑ scene
- ‚úÖ –ù–µ—Ç —Ç–æ–∫–µ–Ω–∞ ‚Üí –≤—ã—Ö–æ–¥ —Å —Å–æ–æ–±—â–µ–Ω–∏–µ–º

---

### 1.3 searchShop.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –•–æ—Ä–æ—à–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 1 (P2)

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –ú–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –í–°–ï —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (bug fix –∏–∑ DIAGNOSTIC_REPORT)
- ‚úÖ Fallback –Ω–∞ seller_first_name –µ—Å–ª–∏ –Ω–µ—Ç username
- ‚úÖ –ü–µ—Ä–µ–¥–∞–µ—Ç is_subscribed –≤ keyboard

**–ü—Ä–æ–±–ª–µ–º—ã:**

#### P2: Token –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤ searchShops
**–õ–æ–∫–∞—Ü–∏—è:** `searchShop.js:55`
```javascript
const shops = await shopApi.searchShops(query, ctx.session?.token);
```

**–ü–æ—á–µ–º—É —ç—Ç–æ –ø—Ä–æ–±–ª–µ–º–∞:**
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω ‚Üí `token = undefined`
- API –≤–µ—Ä–Ω–µ—Ç –º–∞–≥–∞–∑–∏–Ω—ã –ë–ï–ó —Ñ–ª–∞–≥–∞ `is_subscribed`
- –ö–Ω–æ–ø–∫–∏ "–ü–æ–¥–ø–∏—Å–∞—Ç—å—Å—è" –º–æ–≥—É—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```javascript
// –ü—Ä–æ–≤–µ—Ä–∏—Ç—å token –ø–µ—Ä–µ–¥ search
if (!ctx.session?.token) {
  await ctx.reply('–ù–µ–æ–±—Ö–æ–¥–∏–º–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è. /start', buyerMenu);
  return await ctx.scene.leave();
}

const shops = await shopApi.searchShops(query, ctx.session.token);
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (–Ω–µ –∫—Ä–∏—Ç–∏—á–Ω–æ, –Ω–æ –º–æ–∂–µ—Ç —Å–±–∏—Ç—å —Å —Ç–æ–ª–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)

---

### 1.4 manageWallets.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ 3-step wizard –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (show ‚Üí select crypto ‚Üí enter address)
- ‚úÖ –ö—Ä–∏–ø—Ç–æ-–≤–∞–ª–∏–¥–∞—Ü–∏—è —á–µ—Ä–µ–∑ `validateCryptoAddress()` (—Å—Ç—Ä–æ–∫–∞ 161)
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π UI (wallet status inline: BTC ‚úì | ETH ‚óã)
- ‚úÖ Hint –µ—Å–ª–∏ –≤—Å–µ –∫–æ—à–µ–ª—å–∫–∏ –ø—É—Å—Ç—ã (—Å—Ç—Ä–æ–∫–∞ 66-68)
- ‚úÖ Session check –Ω–∞ –∫–∞–∂–¥–æ–º —à–∞–≥–µ (shopId + token)
- ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ callback queries

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ error messages —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏ –∞–¥—Ä–µ—Å–æ–≤ (getCryptoValidationError)
- –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –¥–ª–∏–Ω–∞ –∞–¥—Ä–µ—Å–∞ 10 —Å–∏–º–≤–æ–ª–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 155)
- –£–¥–∞–ª–µ–Ω–∏–µ undefined –ø–æ–ª–µ–π –ø–µ—Ä–µ–¥ API call (—Å—Ç—Ä–æ–∫–∞ 186-188)
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Ç–æ–ª—å–∫–æ prefix –∞–¥—Ä–µ—Å–∞ (—Å—Ç—Ä–æ–∫–∞ 172)

**Edge cases —É—á—Ç–µ–Ω—ã:**
- ‚úÖ –ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç–∞ ‚Üí answerCbQuery —Å —Ç–µ–∫—Å—Ç–æ–º
- ‚úÖ –ù–µ—Ç crypto –≤ wizard.state ‚Üí –≤—ã—Ö–æ–¥
- ‚úÖ –ö–æ—Ä–æ—Ç–∫–∏–π –∞–¥—Ä–µ—Å (< 10 —Å–∏–º–≤–æ–ª–æ–≤)
- ‚úÖ –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç (BTC/ETH/USDT/TON validation)

---

## 2. Handlers

### 2.1 start.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –•–æ—Ä–æ—à–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 1 (P2)

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –ò–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å /start (–ø—Ä–æ–≤–µ—Ä–∫–∞ saved role)
- ‚úÖ Redirect –≤ seller/buyer dashboard –µ—Å–ª–∏ —Ä–æ–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞
- ‚úÖ fakeCtx –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–∫–æ–Ω—Å—Ç—Ä—É–∏—Ä–æ–≤–∞–Ω (explicit getters copy)
- ‚úÖ Fallback –Ω–∞ role selection –µ—Å–ª–∏ –Ω–µ—Ç saved role

**–ü—Ä–æ–±–ª–µ–º—ã:**

#### P2: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ fakeCtx –ª–æ–≥–∏–∫–∏
**–õ–æ–∫–∞—Ü–∏—è:** `start.js:20-30, 37-47`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```javascript
// –î–≤–∞ –∏–¥–µ–Ω—Ç–∏—á–Ω—ã—Ö –±–ª–æ–∫–∞ fakeCtx –¥–ª—è seller –∏ buyer
const fakeCtx = {
  ...ctx,
  from: ctx.from,
  message: ctx.message,
  chat: ctx.chat,
  session: ctx.session,
  answerCbQuery: async () => {},
  editMessageText: async (text, keyboard) => {
    return await ctx.reply(text, keyboard);
  }
};
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```javascript
// –í—ã–Ω–µ—Å—Ç–∏ –≤ —É—Ç–∏–ª–∏—Ç—É
function createFakeCallbackContext(ctx) {
  return {
    ...ctx,
    from: ctx.from,
    message: ctx.message,
    chat: ctx.chat,
    session: ctx.session,
    answerCbQuery: async () => {},
    editMessageText: async (text, keyboard) => {
      return await ctx.reply(text, keyboard);
    }
  };
}

// –í start.js
const fakeCtx = createFakeCallbackContext(ctx);
await handleSellerRole(fakeCtx);
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (DRY principle, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É)

---

### 2.2 buyer/index.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 2 (P1: 1, P2: 1)

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –≤ –ë–î —á–µ—Ä–µ–∑ authApi.updateRole (—Å—Ç—Ä–æ–∫–∞ 52)
- ‚úÖ Check subscription –ü–ï–†–ï–î subscribe (—Å—Ç—Ä–æ–∫–∞ 169-186) - –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –¥—É–±–ª–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ backend errors —Å –ø–∞—Ä—Å–∏–Ω–≥–æ–º —Å–æ–æ–±—â–µ–Ω–∏–π (—Å—Ç—Ä–æ–∫–∞ 207-214)
- ‚úÖ CTA "–°–æ–∑–¥–∞—Ç—å –º–∞–≥–∞–∑–∏–Ω ($25)" –¥–ª—è buyer –±–µ–∑ –º–∞–≥–∞–∑–∏–Ω–∞ (—Å—Ç—Ä–æ–∫–∞ 63-76)
- ‚úÖ –í—Å–µ answerCbQuery() –≤—ã–∑–≤–∞–Ω—ã –æ–¥–∏–Ω —Ä–∞–∑
- ‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç—Ç–µ—Ä–æ–≤

**–ü—Ä–æ–±–ª–µ–º—ã:**

#### P1: Race condition –≤ handleSubscribe
**–õ–æ–∫–∞—Ü–∏—è:** `buyer/index.js:158-216`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```javascript
// –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫—É
const checkResult = await subscriptionApi.checkSubscription(shopId, ctx.session.token);

if (checkResult.subscribed) {
  // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º "—É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω"
  await ctx.answerCbQuery('‚ÑπÔ∏è –í—ã —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω—ã –Ω–∞ —ç—Ç–æ—Ç –º–∞–≥–∞–∑–∏–Ω');

  // ‚ùå –ü–†–û–ë–õ–ï–ú–ê: –ú–µ–∂–¥—É check –∏ subscribe –º–æ–∂–µ—Ç –ø—Ä–æ–π—Ç–∏ –≤—Ä–µ–º—è
  // –î—Ä—É–≥–æ–π –ø—Ä–æ—Ü–µ—Å—Å –º–æ–∂–µ—Ç —É—Å–ø–µ—Ç—å –∏–∑–º–µ–Ω–∏—Ç—å subscription status
  await ctx.editMessageText(...);
  return;
}

// –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è
await subscriptionApi.subscribe(shopId, ctx.session.token);
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- Backend –¥–æ–ª–∂–µ–Ω –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å idempotent subscribe (–µ—Å–ª–∏ —É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω ‚Üí 200 OK)
- Frontend –ø—Ä–æ—Å—Ç–æ –≤—ã–∑—ã–≤–∞–µ—Ç subscribe, –±–µ–∑ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ check
- Backend —Å–∞–º —Ä–µ—à–∞–µ—Ç: —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø–æ–¥–ø–∏—Å–∫—É –∏–ª–∏ –≤–µ—Ä–Ω—É—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P1 (—Ä–µ–¥–∫–∏–π edge case, –Ω–æ –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥–≤–æ–π–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–µ –≤ hi-load)

#### P2: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ error handling
**–õ–æ–∫–∞—Ü–∏—è:** `buyer/index.js:88-97, 112-120`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```javascript
// –û–¥–∏–Ω–∞–∫–æ–≤—ã–µ catch –±–ª–æ–∫–∏ –≤ —Ä–∞–∑–Ω—ã—Ö handlers
catch (error) {
  logger.error('Error in X handler:', error);
  try {
    await ctx.editMessageText(
      '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
      buyerMenu
    );
  } catch (replyError) {
    logger.error('Failed to send error message:', replyError);
  }
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```javascript
// utils/errorHandler.js
export async function handleBotError(ctx, error, keyboard, customMessage = null) {
  logger.error(`Error in ${ctx.updateType} handler:`, error);
  try {
    await ctx.editMessageText(
      customMessage || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ',
      keyboard
    );
  } catch (replyError) {
    logger.error('Failed to send error message:', replyError);
  }
}

// –í handlers
catch (error) {
  await handleBotError(ctx, error, buyerMenu);
}
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (—É–ª—É—á—à–µ–Ω–∏–µ DRY, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É)

---

### 2.3 seller/index.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –•–æ—Ä–æ—à–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 1 (P2)

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –ë–ê–ì #9 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω: token check –ø–µ—Ä–µ–¥ getMyShop (—Å—Ç—Ä–æ–∫–∞ 33-42)
- ‚úÖ –ë–ê–ì #5 –∏—Å–ø—Ä–∞–≤–ª–µ–Ω: —Ä–∞–∑–ª–∏—á–∏–µ –º–µ–∂–¥—É 404/401 –∏ network errors (—Å—Ç—Ä–æ–∫–∞ 82-98)
- ‚úÖ –ü–µ—Ä–≤—ã–π –º–∞–≥–∞–∑–∏–Ω –±–µ—Ä–µ—Ç—Å—è –∏–∑ –º–∞—Å—Å–∏–≤–∞ (—Å—Ç—Ä–æ–∫–∞ 55)
- ‚úÖ Session update –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (shopId + shopName)
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –≤ –ë–î (—Å—Ç—Ä–æ–∫–∞ 19-27)
- ‚úÖ Token check –≤ handleProducts/handleSales

**–ü—Ä–æ–±–ª–µ–º—ã:**

#### P2: –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ shopId –≤ –∫–∞–∂–¥–æ–º handler
**–õ–æ–∫–∞—Ü–∏—è:** `seller/index.js:144-151, 177-184, 223-228, 267-274`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```javascript
// –î—É–±–ª–∏—Ä—É–µ—Ç—Å—è –≤–æ –≤—Å–µ—Ö handlers
if (!ctx.session.shopId) {
  await ctx.editMessageText(
    '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω',
    sellerMenuNoShop
  );
  return;
}
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
```javascript
// middleware/requireShop.js
export function requireShop(handler) {
  return async (ctx) => {
    if (!ctx.session.shopId) {
      await ctx.editMessageText(
        '–°–Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–π—Ç–µ –º–∞–≥–∞–∑–∏–Ω',
        sellerMenuNoShop
      );
      return;
    }
    return handler(ctx);
  };
}

// –í setupSellerHandlers
bot.action('seller:add_product', requireShop(handleAddProduct));
bot.action('seller:products', requireShop(handleProducts));
```

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (—É–ª—É—á—à–µ–Ω–∏–µ DRY)

---

### 2.4 common.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ handleMainMenu –ø—Ä–æ–≤–µ—Ä—è–µ—Ç saved role (—Å—Ç—Ä–æ–∫–∞ 34-42)
- ‚úÖ Redirect –≤ dashboard –≤–º–µ—Å—Ç–æ reset —Ä–æ–ª–∏ (UX improvement)
- ‚úÖ handleRoleToggle –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ—Ç —Ä–æ–ª—å
- ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –≤ –ë–î —Å fallback (—Å—Ç—Ä–æ–∫–∞ 156-172)
- ‚úÖ –í—Å–µ error handlers –∏–º–µ—é—Ç local try-catch

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- Role toggle —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ
- Fallback –Ω–∞ local session –µ—Å–ª–∏ –Ω–µ—Ç —Ç–æ–∫–µ–Ω–∞
- Redirect –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π handler –ø–æ—Å–ª–µ toggle

---

## 3. Keyboards

### 3.1 buyer.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ WebApp –∫–Ω–æ–ø–∫–∞ –≤—Å–µ–≥–¥–∞ –ø–µ—Ä–≤–∞—è
- ‚úÖ buyerMenuNoShop –∏–º–µ–µ—Ç CTA "–ú–∞–≥–∞–∑–∏–Ω ($25)"
- ‚úÖ shopActionsKeyboard –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π (isSubscribed)
- ‚úÖ –õ–æ–≥–∏—á–µ—Å–∫–∞—è –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –∫–Ω–æ–ø–æ–∫ (search/subscriptions/orders)

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- "‚úÖ –ü–æ–¥–ø–∏—Å–∞–Ω" - –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ (noop)
- "üîï –û—Ç–ø–∏—Å–∞—Ç—å—Å—è" –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ø–æ–¥–ø–∏—Å–∞–Ω
- "‚ÑπÔ∏è –û –º–∞–≥–∞–∑–∏–Ω–µ" - —É–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–Ω–æ–ø–∫–∞

---

### 3.2 seller.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –•–æ—Ä–æ—à–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 1 (P2)

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ WebApp –∫–Ω–æ–ø–∫–∞ –ø–µ—Ä–≤–∞—è
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ labels (–¢–æ–≤–∞—Ä—ã, –ü—Ä–æ–¥–∞–∂–∏, –ö–æ—à–µ–ª—å–∫–∏)
- ‚úÖ sellerMenuNoShop –∏–º–µ–µ—Ç CTA "–ú–∞–≥–∞–∑–∏–Ω ($25)"
- ‚úÖ productsMenu –∫–æ–º–ø–∞–∫—Ç–Ω–æ–µ

**–ü—Ä–æ–±–ª–µ–º—ã:**

#### P2: –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä shopName
**–õ–æ–∫–∞—Ü–∏—è:** `seller.js:5, 14`

**–ü—Ä–æ–±–ª–µ–º–∞:**
```javascript
export const sellerMenu = (shopName) => Markup.inlineKeyboard([
  // shopName –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –∫–Ω–æ–ø–∫–∞—Ö
  ...
]);

export const productsMenu = (shopName) => Markup.inlineKeyboard([
  // shopName –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
  ...
]);
```

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –õ–∏–±–æ —É–¥–∞–ª–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä (–º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –ø–æ–¥—Ö–æ–¥)
- –õ–∏–±–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–Ω–æ–ø–∫–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä "–¢–æ–≤–∞—Ä—ã: {shopName}")

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (ESLint warning, –Ω–µ –≤–ª–∏—è–µ—Ç –Ω–∞ —Ä–∞–±–æ—Ç—É)

---

### 3.3 main.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ–µ –º–µ–Ω—é –≤—ã–±–æ—Ä–∞ —Ä–æ–ª–∏:**
- ‚úÖ 2 –∫–Ω–æ–ø–∫–∏: –ü–æ–∫—É–ø–∞—Ç–µ–ª—å / –ü—Ä–æ–¥–∞–≤–µ—Ü
- ‚úÖ –≠–º–æ–¥–∑–∏ –ø–æ–Ω—è—Ç–Ω—ã–µ

---

### 3.4 common.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏:**
- ‚úÖ cancelButton –¥–ª—è scenes
- ‚úÖ successButtons –¥–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
- ‚úÖ backButton –¥–ª—è –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
- ‚úÖ mainMenuButton –¥–ª—è –≤–æ–∑–≤—Ä–∞—Ç–∞

---

## 4. Utils

### 4.1 api.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ Axios instance —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ç–µ—Å—Ç–æ–≤ (—Å—Ç—Ä–æ–∫–∞ 265)
- ‚úÖ Request/response interceptors –ª–æ–≥–∏—Ä—É—é—Ç –≤—Å—ë
- ‚úÖ Error interceptor –ª–æ–≥–∏—Ä—É–µ—Ç validation errors + request body
- ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã unwrap response (data.data || data)
- ‚úÖ Array safety checks (—Å—Ç—Ä–æ–∫–∞ 101, 125, 164, 175)
- ‚úÖ telegramId –ø–∞—Ä—Å–∏—Ç—Å—è –≤ integer (—Å—Ç—Ä–æ–∫–∞ 67)

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- Timeout 10 —Å–µ–∫—É–Ω–¥
- Authorization headers —á–µ—Ä–µ–∑ Bearer token
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –æ—à–∏–±–æ–∫ (requestBody, validationErrors)
- Unwrapping response –¥–ª—è —É–ø—Ä–æ—â–µ–Ω–∏—è handlers

---

### 4.2 validation.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ wallet-address-validator –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥–ª—è BTC/ETH
- ‚úÖ TON validation —á–µ—Ä–µ–∑ regex (EQ/UQ prefix, base64)
- ‚úÖ USDT = Ethereum (ERC-20)
- ‚úÖ –ò–Ω—Ñ–æ—Ä–º–∞—Ç–∏–≤–Ω—ã–µ error messages —Å –ø—Ä–∏–º–µ—Ä–∞–º–∏

**Coverage:** 100% (26 —Ç–µ—Å—Ç–æ–≤)

---

### 4.3 format.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ formatPrice —É–±–∏—Ä–∞–µ—Ç .00 –¥–ª—è —Ü–µ–ª—ã—Ö —á–∏—Å–µ–ª
- ‚úÖ formatPriceFixed –≤—Å–µ–≥–¥–∞ 2 decimals
- ‚úÖ formatNumber —É–±–∏—Ä–∞–µ—Ç trailing zeros
- ‚úÖ formatOrderStatus –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ emoji

**Coverage:** 100% (32 —Ç–µ—Å—Ç–∞)

---

### 4.4 minimalist.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ formatProductsList: 8 lines ‚Üí 3 lines (63% reduction)
- ‚úÖ formatSalesList: 9 lines ‚Üí 4 lines (56% reduction)
- ‚úÖ formatShopInfo: 13 lines ‚Üí 7 lines (46% reduction)
- ‚úÖ formatWallets: 9 lines ‚Üí 3 lines (67% reduction)
- ‚úÖ Empty state messages –ø–æ–Ω—è—Ç–Ω—ã–µ
- ‚úÖ Limit –Ω–∞ –ø–æ–∫–∞–∑ (5-10 —ç–ª–µ–º–µ–Ω—Ç–æ–≤)

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- "+N –µ—â—ë" –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö —Å–ø–∏—Å–∫–æ–≤
- Username truncation (max 15 —Å–∏–º–≤–æ–ª–æ–≤)
- Smart price formatting (—Ü–µ–ª—ã–µ –±–µ–∑ .00)
- Inline wallet status (BTC ‚úì | ETH ‚óã)

---

## 5. Middleware

### 5.1 auth.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è/–ª–æ–≥–∏–Ω –Ω–∞ –∫–∞–∂–¥–æ–º –∑–∞–ø—Ä–æ—Å–µ
- ‚úÖ Session cache (–Ω–µ –≤—ã–∑—ã–≤–∞–µ—Ç API –µ—Å–ª–∏ token –µ—Å—Ç—å)
- ‚úÖ Graceful fallback –µ—Å–ª–∏ API —É–ø–∞–ª (—Å—Ç—Ä–æ–∫–∞ 49-64)
- ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ camelCase –∏ snake_case (firstName/first_name)
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–π –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏

**Coverage:** 61.53% (9 —Ç–µ—Å—Ç–æ–≤)

---

### 5.2 error.js

**–°—Ç–∞—Ç—É—Å:** ‚ö†Ô∏è –ù–µ –ø—Ä–æ–≤–µ—Ä–µ–Ω (0% coverage)
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 1 (P2)

**–ü—Ä–æ–±–ª–µ–º–∞:**

#### P2: Error middleware –Ω–µ –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏
**–õ–æ–∫–∞—Ü–∏—è:** `middleware/error.js`

**–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:**
- –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã –¥–ª—è error middleware
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ errors –ª–æ–≥–∏—Ä—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å fallback –Ω–∞ generic message

**–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç:** P2 (middleware –∫—Ä–∏—Ç–∏—á–µ–Ω, –Ω–æ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –≤ production)

---

## 6. Bot Configuration

### 6.1 bot.js

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –û—Ç–ª–∏—á–Ω–æ
**–ù–∞–π–¥–µ–Ω–æ –ø—Ä–æ–±–ª–µ–º:** 0

**–ß—Ç–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:**
- ‚úÖ Graceful shutdown (SIGINT/SIGTERM)
- ‚úÖ Global error handler (bot.catch)
- ‚úÖ Session debug middleware (—Å—Ç—Ä–æ–∫–∞ 45-57)
- ‚úÖ Middleware order –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω (session ‚Üí stage ‚Üí auth ‚Üí error)
- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è BOT_TOKEN –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º
- ‚úÖ –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å—Ç–∞—Ä—Ç–∞

**–õ—É—á—à–∏–µ –ø—Ä–∞–∫—Ç–∏–∫–∏:**
- Debug –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ session state
- Catch handler –Ω–µ –±—Ä–æ—Å–∞–µ—Ç –æ—à–∏–±–∫—É –≤ –æ—Ç–≤–µ—Ç
- –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ updateType –≤ –æ—à–∏–±–∫–∞—Ö

---

## 7. –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –ø—Ä–æ–±–ª–µ–º—ã (P0)

**–ù–ï–¢ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–• –ü–†–û–ë–õ–ï–ú** ‚úÖ

---

## 8. –í–∞–∂–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã (P1)

### P1-1: Race condition –≤ handleSubscribe
**–§–∞–π–ª:** `bot/src/handlers/buyer/index.js:158-216`
**–û–ø–∏—Å–∞–Ω–∏–µ:** –ú–µ–∂–¥—É checkSubscription –∏ subscribe –º–æ–∂–µ—Ç –ø—Ä–æ–∏–∑–æ–π—Ç–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞
**–†–µ—à–µ–Ω–∏–µ:** Backend –¥–æ–ª–∂–µ–Ω —Å–¥–µ–ª–∞—Ç—å subscribe –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω—ã–º (upsert –≤–º–µ—Å—Ç–æ insert)
**–í–ª–∏—è–Ω–∏–µ:** –†–µ–¥–∫–∏–π edge case, –º–æ–∂–µ—Ç –ø—Ä–∏–≤–µ—Å—Ç–∏ –∫ –¥—É–±–ª–∏–∫–∞—Ç–∞–º –≤ hi-load

---

## 9. Nice to Have (P2)

### P2-1: Token –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π –≤ searchShops
**–§–∞–π–ª:** `bot/src/scenes/searchShop.js:55`
**–†–µ—à–µ–Ω–∏–µ:** –¢—Ä–µ–±–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –ø–µ—Ä–µ–¥ –ø–æ–∏—Å–∫–æ–º

### P2-2: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ fakeCtx –ª–æ–≥–∏–∫–∏
**–§–∞–π–ª:** `bot/src/handlers/start.js:20-47`
**–†–µ—à–µ–Ω–∏–µ:** –í—ã–Ω–µ—Å—Ç–∏ –≤ —É—Ç–∏–ª–∏—Ç—É `createFakeCallbackContext()`

### P2-3: –î—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ error handling
**–§–∞–π–ª:** `bot/src/handlers/buyer/index.js`, `seller/index.js`
**–†–µ—à–µ–Ω–∏–µ:** –°–æ–∑–¥–∞—Ç—å `utils/errorHandler.js`

### P2-4: –ò–∑–±—ã—Ç–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ shopId
**–§–∞–π–ª:** `bot/src/handlers/seller/index.js`
**–†–µ—à–µ–Ω–∏–µ:** Middleware `requireShop(handler)`

### P2-5: –ù–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä shopName
**–§–∞–π–ª:** `bot/src/keyboards/seller.js:5, 14`
**–†–µ—à–µ–Ω–∏–µ:** –£–¥–∞–ª–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –≤ –∫–Ω–æ–ø–∫–∞—Ö

### P2-6: Error middleware –Ω–µ –ø–æ–∫—Ä—ã—Ç —Ç–µ—Å—Ç–∞–º–∏
**–§–∞–π–ª:** `bot/src/middleware/error.js`
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å unit —Ç–µ—Å—Ç—ã

### P2-7: Handlers 0% coverage
**–§–∞–π–ª:** `bot/src/handlers/*`
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å integration —Ç–µ—Å—Ç—ã –¥–ª—è –≤—Å–µ—Ö handlers
**–¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å:** 22 integration —Ç–µ—Å—Ç–∞ (—Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ flows)

### P2-8: Scenes 2% coverage
**–§–∞–π–ª:** `bot/src/scenes/*`
**–†–µ—à–µ–Ω–∏–µ:** –î–æ–±–∞–≤–∏—Ç—å —Ç–µ—Å—Ç—ã –¥–ª—è edge cases –≤ –∫–∞–∂–¥–æ–º scene

---

## 10. Telegraf.js Best Practices Compliance

### ‚úÖ –°–æ–±–ª—é–¥–µ–Ω–æ:
- ‚úÖ Context –≥–µ—Ç—Ç–µ—Ä—ã –∫–æ–ø–∏—Ä—É—é—Ç—Å—è —è–≤–Ω–æ (fakeCtx –≤ start.js)
- ‚úÖ answerCbQuery() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –û–î–ò–ù —Ä–∞–∑ –≤ –∫–∞–∂–¥–æ–º callback handler
- ‚úÖ Backend error parsing –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- ‚úÖ editMessageText vs reply –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è
- ‚úÖ Session management –∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
- ‚úÖ Scene cleanup –≤ leave handlers
- ‚úÖ Local error handling (don't throw –≤ catch)

### ‚ö†Ô∏è –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:
- ‚ö†Ô∏è –í –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö handlers answerCbQuery() –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –î–û async –æ–ø–µ—Ä–∞—Ü–∏–π (–Ω–æ —ç—Ç–æ –û–ö –¥–ª—è UX - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º spinner –ø–æ–∫–∞ –≥—Ä—É–∑–∏–º –¥–∞–Ω–Ω—ã–µ)

---

## 11. UX Acceptance Criteria

### ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ:
- ‚úÖ –ï–¥–∏–Ω–∞—è –≤–µ—Ä—Ö–Ω—è—è –∫–Ω–æ–ø–∫–∞ "üì± –û—Ç–∫—Ä—ã—Ç—å" —É –æ–±–µ–∏—Ö —Ä–æ–ª–µ–π
- ‚úÖ –ü–∞–º—è—Ç—å —Ä–æ–ª–∏: /start –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–µ–Ω, —Ä–æ–ª—å –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–∞ (–ë–î)
- ‚úÖ –û–¥–Ω–∞ –∫–Ω–æ–ø–∫–∞-—Ç–æ–≥–≥–ª "üîÑ –ü—Ä–æ–¥–∞–≤–µ—Ü" / "üîÑ –ü–æ–∫—É–ø–∞—Ç–µ–ª—å"
- ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∏: —è–≤–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (—É—Å–ø–µ—Ö/—É–∂–µ –ø–æ–¥–ø–∏—Å–∞–Ω)
- ‚úÖ Buyer –±–µ–∑ –º–∞–≥–∞–∑–∏–Ω–∞: CTA "‚ûï –ú–∞–≥–∞–∑–∏–Ω ($25)"
- ‚úÖ –ú–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è (BOT_MINIMALIST_DESIGN_GUIDE.md)

---

## 12. API Integration

### Endpoints –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ:
- ‚úÖ `/auth/register` - POST —Å telegramId integer
- ‚úÖ `/auth/role` - PATCH –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ä–æ–ª–∏
- ‚úÖ `/shops/my` - GET —Å Bearer token
- ‚úÖ `/shops` - POST –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
- ‚úÖ `/shops/search?q=` - GET —Å query params
- ‚úÖ `/products` - POST/GET —Å shopId
- ‚úÖ `/orders/my` - GET buyer orders
- ‚úÖ `/orders?shopId=` - GET seller orders
- ‚úÖ `/subscriptions` - POST/GET/DELETE
- ‚úÖ `/subscriptions/check/:id` - GET subscription status
- ‚úÖ `/shops/:id/wallets` - GET/PUT wallets

### Response unwrapping:
- ‚úÖ –í—Å–µ –º–µ—Ç–æ–¥—ã –¥–µ–ª–∞—é—Ç `data.data || data` (—Å—Ç—Ä–æ–∫–∏ 79, 90, 110, 132, etc.)
- ‚úÖ Array safety checks –¥–æ–±–∞–≤–ª–µ–Ω—ã

---

## 13. Session Management

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ session:
```javascript
ctx.session = {
  token: string,           // JWT token
  user: {
    telegramId: number,
    username: string,
    firstName: string,
    selectedRole: 'buyer' | 'seller'
  },
  role: 'buyer' | 'seller', // –¢–µ–∫—É—â–∞—è —Ä–æ–ª—å (–º–æ–∂–µ—Ç –æ—Ç–ª–∏—á–∞—Ç—å—Å—è –æ—Ç selectedRole)
  shopId: number | null,    // –ú–∞–≥–∞–∑–∏–Ω –ø—Ä–æ–¥–∞–≤—Ü–∞
  shopName: string | null   // –ò–º—è –º–∞–≥–∞–∑–∏–Ω–∞
}
```

### ‚úÖ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å:
- ‚úÖ Session –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è –≤ auth middleware
- ‚úÖ shopId/shopName –æ–±–Ω–æ–≤–ª—è—é—Ç—Å—è –ø–æ—Å–ª–µ —Å–æ–∑–¥–∞–Ω–∏—è –º–∞–≥–∞–∑–∏–Ω–∞
- ‚úÖ role —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –ë–î —á–µ—Ä–µ–∑ authApi.updateRole
- ‚úÖ Wizard state –æ—á–∏—â–∞–µ—Ç—Å—è –≤ scene.leave

---

## 14. Logging

### ‚úÖ –û—Ç–ª–∏—á–Ω–æ:
- ‚úÖ Winston logger –Ω–∞—Å—Ç—Ä–æ–µ–Ω (levels, transports)
- ‚úÖ –õ–æ–≥–∏—Ä—É—é—Ç—Å—è –≤—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–±—ã—Ç–∏—è (shop_created, product_saved, etc.)
- ‚úÖ Session state –≤ debug mode (bot.js:45-57)
- ‚úÖ API errors —Å –ø–æ–ª–Ω—ã–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º (requestBody, validationErrors)
- ‚úÖ Sensitive data —Å–∫—Ä—ã—Ç–∞ (wallet address prefix only)

---

## 15. –û–±—â–∞—è –æ—Ü–µ–Ω–∫–∞ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Ç–∞: 85/100

### Breakdown:
- **–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞:** 95/100 (—á–∏—Å—Ç–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞, –∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è –æ—Ä–≥–∞–Ω–∏–∑–∞—Ü–∏—è)
- **–û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫:** 90/100 (try-catch –≤–µ–∑–¥–µ, local error handling)
- **–í–∞–ª–∏–¥–∞—Ü–∏—è:** 100/100 (crypto validation + input validation)
- **UX:** 85/100 (–º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π, –Ω–æ –Ω–µ–∫–æ—Ç–æ—Ä—ã–µ edge cases –º–æ–≥—É—Ç —Å–±–∏—Ç—å —Å —Ç–æ–ª–∫—É)
- **Session management:** 90/100 (–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π, –Ω–æ –Ω–µ—Ç persistence –º–µ–∂–¥—É –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–º–∏)
- **API Integration:** 95/100 (–ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ endpoints, unwrapping, error handling)
- **Testing:** 60/100 (11.56% coverage, –Ω—É–∂–Ω–æ –±–æ–ª—å—à–µ integration —Ç–µ—Å—Ç–æ–≤)
- **Code quality:** 85/100 (DRY –º–æ–∂–Ω–æ —É–ª—É—á—à–∏—Ç—å, –Ω–æ –∫–æ–¥ —á–∏—Ç–∞–µ–º—ã–π)

---

## 16. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º

### –°—Ä–æ—á–Ω–æ (–≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏):
1. ‚úÖ **P1-1**: –ò—Å–ø—Ä–∞–≤–∏—Ç—å race condition –≤ subscribe (backend –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)

### –í–∞–∂–Ω–æ (–≤ —Ç–µ—á–µ–Ω–∏–µ –º–µ—Å—è—Ü–∞):
2. **P2-1**: –¢—Ä–µ–±–æ–≤–∞—Ç—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –≤ searchShops
3. **P2-7**: –£–≤–µ–ª–∏—á–∏—Ç—å coverage handlers –¥–æ —Ö–æ—Ç—è –±—ã 50% (–¥–æ–±–∞–≤–∏—Ç—å ~50 —Ç–µ—Å—Ç–æ–≤)
4. **P2-8**: –£–≤–µ–ª–∏—á–∏—Ç—å coverage scenes –¥–æ —Ö–æ—Ç—è –±—ã 50% (–¥–æ–±–∞–≤–∏—Ç—å ~30 —Ç–µ—Å—Ç–æ–≤)

### Nice to have (–∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –≤—Ä–µ–º—è):
5. **P2-2**: –í—ã–Ω–µ—Å—Ç–∏ fakeCtx –≤ —É—Ç–∏–ª–∏—Ç—É
6. **P2-3**: –°–æ–∑–¥–∞—Ç—å errorHandler —É—Ç–∏–ª–∏—Ç—É
7. **P2-4**: Middleware requireShop
8. **P2-5**: –£–±—Ä–∞—Ç—å –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π shopName –ø–∞—Ä–∞–º–µ—Ç—Ä
9. **P2-6**: –ü–æ–∫—Ä—ã—Ç—å error middleware —Ç–µ—Å—Ç–∞–º–∏

---

## 17. –§–∞–π–ª—ã —Ç—Ä–µ–±—É—é—â–∏–µ –≤–Ω–∏–º–∞–Ω–∏—è

### üî¥ –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
- `bot/src/handlers/buyer/index.js` - P1 race condition
- `bot/src/middleware/error.js` - 0% coverage

### üü° –°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
- `bot/src/handlers/start.js` - –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ fakeCtx
- `bot/src/scenes/searchShop.js` - token –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π
- `bot/src/keyboards/seller.js` - –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–π –ø–∞—Ä–∞–º–µ—Ç—Ä

### üü¢ –ù–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç:
- –í—Å–µ handlers - —É–ª—É—á—à–∏—Ç—å DRY
- –í—Å–µ scenes - —É–≤–µ–ª–∏—á–∏—Ç—å test coverage

---

## 18. –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

**–ë–æ—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç –û–¢–õ–ò–ß–ù–û** –¥–ª—è production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è. –í—Å–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ —Ñ—É–Ω–∫—Ü–∏–∏ –ø–æ–∫—Ä—ã—Ç—ã, –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –Ω–∞ –≤—ã—Å–æ–∫–æ–º —É—Ä–æ–≤–Ω–µ, UX –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–π –∏ –ø–æ–Ω—è—Ç–Ω—ã–π.

**–û—Å–Ω–æ–≤–Ω–∞—è –∑–∞–¥–∞—á–∞** - —É–≤–µ–ª–∏—á–∏—Ç—å test coverage —Å 11.56% –¥–æ —Ö–æ—Ç—è –±—ã 50% –¥–ª—è —É–≤–µ—Ä–µ–Ω–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –±—É–¥—É—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö.

**–ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞** —á–∏—Å—Ç–∞—è, –ª–µ–≥–∫–æ —Ä–∞—Å—à–∏—Ä—è–µ–º–∞—è. –ù–æ–≤—ã–µ —Å—Ü–µ–Ω—ã/handlers –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –ø–æ —Ç–æ–º—É –∂–µ –ø–∞—Ç—Ç–µ—Ä–Ω—É.

---

**–ü–æ–¥–ø–∏—Å—å:** Claude Code (Sonnet 4.5)
**–ú–µ—Ç–æ–¥:** MCP Filesystem (Read + Grep + Glob)
**–í—Ä–µ–º—è –∞—É–¥–∏—Ç–∞:** ~20 –º–∏–Ω—É—Ç
**–§–∞–π–ª–æ–≤ –ø—Ä–æ–≤–µ—Ä–µ–Ω–æ:** 20+
